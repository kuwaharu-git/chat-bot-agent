<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ウェブサイト情報チャットボット</title>
    <!-- マークダウンをHTMLに変換するためのライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <!-- シンタックスハイライト用のライブラリ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .url-form {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        .url-input-row {
            display: flex;
            margin-bottom: 10px;
        }
        .url-form input[type="url"] {
            flex-grow: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }
        .url-form button {
            padding: 10px 15px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        .subpage-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .subpage-option input[type="checkbox"] {
            margin-right: 8px;
        }
        .advanced-options {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }
        .advanced-options.visible {
            display: block;
        }
        .option-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .option-row label {
            width: 150px;
        }
        .option-row input[type="number"] {
            width: 60px;
            padding: 5px;
        }
        .toggle-advanced {
            background: none;
            border: none;
            color: #2196F3;
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
            margin-top: 5px;
            font-size: 14px;
        }
        .chat-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .user-message {
            background-color: #f1f1f1;
            text-align: right;
        }
        .bot-message {
            background-color: #e3f2fd;
            text-align: left;
        }
        .chat-form {
            display: flex;
        }
        .chat-form input {
            flex-grow: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }
        .chat-form button {
            padding: 10px 15px;
            font-size: 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        .status {
            text-align: center;
            color: #555;
            margin-bottom: 20px;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        /* マークダウン内のスタイル */
        .markdown-content {
            line-height: 1.6;
        }
        .markdown-content h1, 
        .markdown-content h2, 
        .markdown-content h3, 
        .markdown-content h4 {
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        .markdown-content ul, 
        .markdown-content ol {
            padding-left: 20px;
        }
        .markdown-content pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .markdown-content code {
            font-family: monospace;
            background-color: #f5f5f5;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        .markdown-content th, 
        .markdown-content td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .markdown-content th {
            background-color: #f2f2f2;
        }
        .markdown-content blockquote {
            border-left: 4px solid #ddd;
            padding-left: 10px;
            margin-left: 0;
            color: #666;
        }
        
        /* キャッシュ関連のスタイル */
        .cache-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .cache-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
        }
        .cache-hit {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .cache-miss {
            background-color: #fbe9e7;
            color: #c62828;
        }
        .cache-controls {
            margin-top: 10px;
        }
        .cache-controls button {
            background: none;
            border: none;
            color: #2196F3;
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
            font-size: 14px;
            margin-right: 10px;
        }
        
        /* キャッシュサイト一覧のスタイル */
        .cached-sites-container {
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .cached-sites-container.visible {
            display: block;
        }
        .cached-site-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cached-site-item:hover {
            background-color: #f5f5f5;
        }
        .cached-site-item:last-child {
            border-bottom: none;
        }
        .site-title {
            font-weight: bold;
            margin-bottom: 3px;
        }
        .site-url {
            font-size: 12px;
            color: #666;
            word-break: break-all;
        }
        .site-meta {
            font-size: 12px;
            color: #999;
        }
        .site-select-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }
        .site-select-btn:hover {
            background-color: #0b7dda;
        }
    </style>
</head>
<body>
    <h1>ウェブサイト情報チャットボット</h1>
    
    <div class="status" id="status">URLを入力するか、キャッシュされたサイトを選択してください</div>
    
    <div class="url-form">
        <div class="url-input-row">
            <input type="url" id="url-input" placeholder="https://example.com">
            <button id="initialize-btn">初期化</button>
        </div>
        <div class="subpage-option">
            <input type="checkbox" id="include-subpages" checked>
            <label for="include-subpages">サブページも含めてスクレイピングする（より多くの情報を取得できますが、時間がかかります）</label>
        </div>
        <button class="toggle-advanced" id="toggle-advanced">詳細設定を表示</button>
        <div class="advanced-options" id="advanced-options">
            <div class="option-row">
                <label for="max-pages">最大ページ数:</label>
                <input type="number" id="max-pages" value="10" min="1" max="50">
                <span>（多いほど情報量が増えますが、時間がかかります）</span>
            </div>
            <div class="option-row">
                <label for="max-depth">最大探索深さ:</label>
                <input type="number" id="max-depth" value="2" min="1" max="5">
                <span>（深いほど広範囲の情報を取得できますが、関連性が薄くなる可能性があります）</span>
            </div>
            <div class="option-row">
                <label for="use-cache">キャッシュを使用:</label>
                <input type="checkbox" id="use-cache" checked>
                <span>（過去に取得したデータを再利用して高速化します）</span>
            </div>
            <div class="option-row">
                <label for="force-refresh">強制更新:</label>
                <input type="checkbox" id="force-refresh">
                <span>（キャッシュを無視して新しいデータを取得します）</span>
            </div>
        </div>
        
        <div class="cache-info" id="cache-info" style="display: none;">
            <div>キャッシュ統計: <span id="cache-stats">読み込み中...</span></div>
            <div class="cache-controls">
                <button id="clear-cache">期限切れキャッシュを削除</button>
                <button id="show-cached-sites">キャッシュ済みサイトを表示/非表示</button>
            </div>
            
            <!-- キャッシュ済みサイト一覧 -->
            <div class="cached-sites-container" id="cached-sites-container">
                <div id="cached-sites-list">
                    <!-- サイト一覧がここに表示されます -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="chat-container" id="chat-container">
        <!-- メッセージはここに表示されます -->
    </div>
    
    <div class="chat-form">
        <input type="text" id="message-input" placeholder="質問を入力..." disabled>
        <button id="send-btn" disabled>送信</button>
    </div>
    
    <script>
        // ライブラリのロードを確認してから実行する関数
        function initializeApp() {
            // マークダウンのオプション設定
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,  // 改行を有効にする
                    gfm: true,     // GitHub Flavored Markdownを有効にする
                    highlight: function(code, lang) {
                        // シンタックスハイライトを適用
                        if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                            return hljs.highlight(code, { language: lang }).value;
                        }
                        return code;
                    }
                });
            } else {
                console.error('marked ライブラリがロードされていません');
            }
            
            // DOMが読み込まれたら実行
            document.addEventListener('DOMContentLoaded', function() {
                const urlInput = document.getElementById('url-input');
                const includeSubpages = document.getElementById('include-subpages');
                const maxPages = document.getElementById('max-pages');
                const maxDepth = document.getElementById('max-depth');
                const useCache = document.getElementById('use-cache');
                const forceRefresh = document.getElementById('force-refresh');
                const toggleAdvanced = document.getElementById('toggle-advanced');
                const advancedOptions = document.getElementById('advanced-options');
                const initializeBtn = document.getElementById('initialize-btn');
                const messageInput = document.getElementById('message-input');
                const sendBtn = document.getElementById('send-btn');
                const chatContainer = document.getElementById('chat-container');
                const statusElement = document.getElementById('status');
                const cacheInfo = document.getElementById('cache-info');
                const cacheStats = document.getElementById('cache-stats');
                const clearCache = document.getElementById('clear-cache');
                const showCachedSites = document.getElementById('show-cached-sites');
                const cachedSitesContainer = document.getElementById('cached-sites-container');
                const cachedSitesList = document.getElementById('cached-sites-list');
                
                // APIのベースURL（必要に応じて変更）
                const API_BASE_URL = 'http://localhost:8000';
                
                // キャッシュ統計情報を取得
                function loadCacheStats() {
                    if (useCache.checked) {
                        cacheInfo.style.display = 'block';
                        
                        fetch(`${API_BASE_URL}/cache/stats`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.sites_count > 0) {
                                    cacheStats.textContent = `${data.sites_count}サイト, ${data.urls_count}URL, ${Math.round(data.db_size_kb)}KB`;
                                } else {
                                    cacheStats.textContent = 'キャッシュなし';
                                }
                            })
                            .catch(error => {
                                cacheStats.textContent = 'エラー: 統計情報を取得できません';
                            });
                    } else {
                        cacheInfo.style.display = 'none';
                    }
                }
                
                // キャッシュ済みサイト一覧を読み込む
                function loadCachedSites() {
                    cachedSitesList.innerHTML = '<div style="text-align: center; padding: 10px;">読み込み中...</div>';
                    
                    fetch(`${API_BASE_URL}/cache/sites`)
                        .then(response => response.json())
                        .then(sites => {
                            cachedSitesList.innerHTML = '';
                            
                            if (sites.length === 0) {
                                cachedSitesList.innerHTML = '<div style="text-align: center; padding: 10px;">キャッシュされたサイトはありません</div>';
                                return;
                            }
                            
                            sites.forEach(site => {
                                const siteItem = document.createElement('div');
                                siteItem.className = 'cached-site-item';
                                
                                const siteInfo = document.createElement('div');
                                
                                const siteTitle = document.createElement('div');
                                siteTitle.className = 'site-title';
                                siteTitle.textContent = site.title || 'タイトルなし';
                                
                                const siteUrl = document.createElement('div');
                                siteUrl.className = 'site-url';
                                siteUrl.textContent = site.url;
                                
                                const siteMeta = document.createElement('div');
                                siteMeta.className = 'site-meta';
                                
                                // 日時をフォーマット
                                const date = new Date(site.last_scraped);
                                const formattedDate = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                                
                                siteMeta.textContent = `${site.pages_count}ページ・${formattedDate}取得`;
                                
                                siteInfo.appendChild(siteTitle);
                                siteInfo.appendChild(siteUrl);
                                siteInfo.appendChild(siteMeta);
                                
                                const selectBtn = document.createElement('button');
                                selectBtn.className = 'site-select-btn';
                                selectBtn.textContent = '選択';
                                selectBtn.addEventListener('click', function() {
                                    // サイトIDが必ず数値であることを確認
                                    const siteId = parseInt(site.id);
                                    if (!isNaN(siteId)) {
                                        initializeFromCachedSite(siteId);
                                    } else {
                                        alert('サイトIDが無効です');
                                    }
                                });
                                
                                siteItem.appendChild(siteInfo);
                                siteItem.appendChild(selectBtn);
                                
                                cachedSitesList.appendChild(siteItem);
                            });
                        })
                        .catch(error => {
                            cachedSitesList.innerHTML = '<div style="text-align: center; padding: 10px;">エラー: サイト一覧を取得できません</div>';
                        });
                }
                
                // キャッシュされたサイトから初期化
                function initializeFromCachedSite(siteId) {
                    // ボタンを無効化し、ステータスを更新
                    initializeBtn.disabled = true;
                    statusElement.textContent = '初期化中...キャッシュからサイト情報を読み込んでいます';
                    
                    // APIにリクエストを送信
                    fetch(`${API_BASE_URL}/initialize/cached/${siteId}`, {
                        method: 'POST'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('初期化に失敗しました');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // 成功時の処理
                        statusElement.textContent = data.answer;
                        
                        // キャッシュ情報を更新
                        loadCacheStats();
                        
                        // キャッシュ状態に応じたメッセージを表示
                        let message = `${data.pages_scraped}ページの情報を取得しました。`;
                        message += ` <span class="cache-badge cache-hit">キャッシュから読み込み</span>`;
                        message += " 質問してください。";
                        
                        addMessage(message, 'bot', true);
                        
                        // チャット入力を有効化
                        messageInput.disabled = false;
                        sendBtn.disabled = false;
                        messageInput.focus();
                        
                        // キャッシュサイト一覧を非表示
                        cachedSitesContainer.classList.remove('visible');
                    })
                    .catch(error => {
                        // エラー時の処理
                        statusElement.textContent = error.message;
                        initializeBtn.disabled = false;
                    });
                }
                
                // 期限切れキャッシュを削除
                clearCache.addEventListener('click', function() {
                    fetch(`${API_BASE_URL}/cache/clear`, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            alert(`${data.deleted_count}件の期限切れキャッシュを削除しました`);
                            loadCacheStats();
                            loadCachedSites();
                        })
                        .catch(error => {
                            alert('キャッシュの削除に失敗しました');
                        });
                });
                
                // キャッシュ済みサイトの表示/非表示
                showCachedSites.addEventListener('click', function() {
                    if (cachedSitesContainer.classList.contains('visible')) {
                        cachedSitesContainer.classList.remove('visible');
                    } else {
                        cachedSitesContainer.classList.add('visible');
                        loadCachedSites();
                    }
                });
                
                // キャッシュチェックボックスの変更時の処理
                useCache.addEventListener('change', function() {
                    loadCacheStats();
                    forceRefresh.disabled = !this.checked;
                });
                
                // 詳細設定の表示/非表示を切り替え
                toggleAdvanced.addEventListener('click', function() {
                    advancedOptions.classList.toggle('visible');
                    toggleAdvanced.textContent = advancedOptions.classList.contains('visible') ? 
                        '詳細設定を隠す' : '詳細設定を表示';
                });
                
                // サブページチェックボックスの変更時の処理
                includeSubpages.addEventListener('change', function() {
                    if (this.checked) {
                        maxPages.disabled = false;
                        maxDepth.disabled = false;
                    } else {
                        maxPages.disabled = true;
                        maxDepth.disabled = true;
                    }
                });
                
                // 初期化時にキャッシュ統計を読み込む
                loadCacheStats();
                
                // チャットボットの初期化
                initializeBtn.addEventListener('click', function() {
                    const url = urlInput.value.trim();
                    if (!url) {
                        alert('URLを入力してください');
                        return;
                    }
                    
                    // ボタンを無効化し、ステータスを更新
                    initializeBtn.disabled = true;
                    statusElement.textContent = '初期化中...サイト情報を取得しています';
                    
                    // APIにリクエストを送信
                    fetch(`${API_BASE_URL}/initialize`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            url: url,
                            include_subpages: includeSubpages.checked,
                            max_pages: parseInt(maxPages.value),
                            max_depth: parseInt(maxDepth.value),
                            use_cache: useCache.checked,
                            force_refresh: forceRefresh.checked
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('初期化に失敗しました');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // 成功時の処理
                        statusElement.textContent = data.answer;
                        
                        // キャッシュ情報を更新
                        loadCacheStats();
                        
                        // キャッシュ状態に応じたメッセージを表示
                        let message = `${data.pages_scraped}ページの情報を取得しました。`;
                        if (useCache.checked) {
                            const cacheStatus = data.from_cache ? 'キャッシュから読み込み' : '新規取得';
                            const badgeClass = data.from_cache ? 'cache-hit' : 'cache-miss';
                            message += ` <span class="cache-badge ${badgeClass}">${cacheStatus}</span>`;
                        }
                        message += " 質問してください。";
                        
                        addMessage(message, 'bot', true);
                        
                        // チャット入力を有効化
                        messageInput.disabled = false;
                        sendBtn.disabled = false;
                        messageInput.focus();
                    })
                    .catch(error => {
                        // エラー時の処理
                        statusElement.textContent = error.message;
                        initializeBtn.disabled = false;
                    });
                });
                
                // メッセージ送信
                function sendMessage() {
                    const message = messageInput.value.trim();
                    if (!message) {
                        return;
                    }
                    
                    // ユーザーメッセージをチャット画面に追加
                    addMessage(message, 'user');
                    
                    // 入力フィールドをクリア
                    messageInput.value = '';
                    
                    // ボタンを無効化
                    sendBtn.disabled = true;
                    messageInput.disabled = true;
                    
                    // APIにリクエストを送信
                    fetch(`${API_BASE_URL}/ask`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ question: message })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('質問の送信に失敗しました');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // ボットの回答をチャット画面に追加
                        addMessage(data.answer, 'bot');
                        
                        // 入力を再度有効化
                        sendBtn.disabled = false;
                        messageInput.disabled = false;
                        messageInput.focus();
                    })
                    .catch(error => {
                        // エラー時の処理
                        addMessage(`エラー: ${error.message}`, 'bot');
                        sendBtn.disabled = false;
                        messageInput.disabled = false;
                    });
                }
                
                // 送信ボタンのクリックイベント
                sendBtn.addEventListener('click', sendMessage);
                
                // Enterキー押下時のイベント
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
                
                // メッセージの追加
                function addMessage(message, sender, allowHTML = false) {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message');
                    messageElement.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
                    
                    if (sender === 'user') {
                        // ユーザーメッセージはプレーンテキスト
                        messageElement.textContent = message;
                    } else {
                        // ボットのメッセージはマークダウンとして解析
                        const markdownDiv = document.createElement('div');
                        markdownDiv.classList.add('markdown-content');
                        
                        if (allowHTML) {
                            // HTMLを直接許可する場合（キャッシュバッジなど）
                            markdownDiv.innerHTML = message;
                        } else {
                            // マークダウンとして解析
                            if (typeof marked !== 'undefined') {
                                markdownDiv.innerHTML = marked.parse(message);
                            } else {
                                markdownDiv.textContent = message;
                            }
                        }
                        
                        messageElement.appendChild(markdownDiv);
                        
                        // コードブロックにシンタックスハイライトを適用
                        if (typeof hljs !== 'undefined') {
                            messageElement.querySelectorAll('pre code').forEach((block) => {
                                hljs.highlightElement(block);
                            });
                        }
                    }
                    
                    chatContainer.appendChild(messageElement);
                    
                    // 自動スクロール
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            });
        }
        
        // ライブラリがロードされたか確認する関数
        function checkLibrariesLoaded() {
            if (typeof marked !== 'undefined' && typeof hljs !== 'undefined') {
                initializeApp();
            } else {
                // ライブラリがまだロードされていない場合、少し待ってから再試行
                setTimeout(checkLibrariesLoaded, 100);
            }
        }
        
        // ページロード時にライブラリのロードを確認
        window.addEventListener('load', checkLibrariesLoaded);
    </script>
</body>
</html> 